<html>
<head>
<title>Magazine</title>
<link rel="stylesheet" href="magazine.css">
<script src="jquery.js"></script>
<script src="jquery.touchSwipe.js"></script>
<script>

/* this is needed only for live resize... */
var PAGES_VISIBLE = 1

$(document).ready(function(){
	$(window).resize(function() {
		fitNPages(PAGES_VISIBLE)
	})

	$('.viewer')
		.swipe({
			//swipeLeft: nextPage,
			//swipeRight: prevPage,
			swipeStatus: swipeUpdate,
			//swipeStatus: unanimated($('.magazine'), swipeUpdate),
			/*
			swipeStatus: function(evt, phase, direction, distance){
				doWithoutTransitions(
					$('.magazine'), 
					function(){swipeUpdate(evt, phase, direction, distance)})
			},
			*/
			// XXX change this to pinch...
			swipeUp: function(){
				PAGES_VISIBLE = 6
				fitNPages(PAGES_VISIBLE)
			},
			// XXX change this to pinch...
			swipeDown: function(){
				PAGES_VISIBLE = 1
				fitNPages(PAGES_VISIBLE)
				// to prevent drag while zooming to affect
				// the resulting position set it to current 
				// page...
				setCurrentPage()
			},
			click: function(evt, elem){
				if($(elem).hasClass('page')){
					setCurrentPage(elem)
				}
				return true
			}
		})

	// XXX add splash screen...

	fitNPages(PAGES_VISIBLE)

})

function swipeUpdate(evt, phase, direction, distance){
	var pages = $('.page')
	var cur = $('.current.page')
	var n = pages.index(cur)
	var scale = getElementScale($('.scaler'))
	var mag = $('.magazine')

	if( phase=='move' && (direction=='left' || direction=='right') ){
		mag.addClass('unanimated')
		if (direction == 'left'){
			//$('.magazine').css({left: -n*cur.width()-distance/scale})
			$('.magazine').css({left: -n*800-distance/scale})
		} else if (direction == 'right') {
			//$('.magazine').css({left: -n*cur.width()+distance/scale})
			$('.magazine').css({left: -n*800+distance/scale})
		}
		setTimeout(function(){mag.removeClass('unanimated')}, 5)

	} else if ( phase == 'cancel') {
		setCurrentPage()

	} else if ( phase =='end' ) {
		// see which page is closer to the middle of the screen and set it...
		var p = Math.ceil((distance/scale)/cur.width())

		if(direction == 'right') {
			// prev page...
			setCurrentPage(Math.max(n-p, 0))
		} else if (direction == 'left'){
			// next page...
			setCurrentPage(Math.min(n+p, pages.length-1))
		}
	}
}


// XXX might be good to use apply here...
function doWithoutTransitions(obj, func, time){
	if(time == null){
		time = 5
	}	
	obj.addClass('unanimated')
	var res = func()
	setTimeout(function(){obj.removeClass('unanimated')}, time)
	return res
}

function unanimated(obj, func, time){
	return function(){
		if(time == null){
			time = 5
		}	
		obj.addClass('unanimated')
		var res = func.apply(func, arguments)
		setTimeout(function(){obj.removeClass('unanimated')}, time)
		return res
	}
}



function setCurrentPage(n){
	if(n == null){
		var cur = $('.current.page')
		n = $('.page').index(cur) 
	} else if(typeof(n) == typeof(1)) {
		var cur = $($('.page')[n])
	} else {
		var cur = $(n)
		n = $('.page').index(cur) 
	}

	$('.current.page').removeClass('current')
	cur.addClass('current')

	var mag = $('.magazine')
	mag.css({left: -n*cur.width()})

	return cur
}



function nextPage(){
	var pages = $('.page')
	var cur = $('.current.page')
	return setCurrentPage(Math.min(pages.index(cur)+1, pages.length-1))
}
function prevPage(){
	var pages = $('.page')
	var cur = $('.current.page')
	return setCurrentPage(Math.max(pages.index(cur)-1, 0))
}


function goToMagazineCover(){
	setCurrentPage(0)
}
function goToArticleCover(){
	setCurrentPage($('.current.page').parents('.article').children('.page').first())
}


function nextArticle(){
	var cur = $('.current.page').parents('.article')
	// we are at the magazine cover cover...
	if(cur.length == 0){
		return setCurrentPage(
			$('.article .page:first-child').first())
	}
	// just find the next one...
	var articles = $('.article')
	return setCurrentPage(
		$(articles[Math.min(articles.index(cur)+1, articles.length-1)])
			.children('.page')
			.first())

}
// XXX this is almost exactly the same as nextArticle...
function prevArticle(){
	var cur = $('.current.page').parents('.article')
	// we are at the magazine cover cover...
	if(cur.length == 0){
		return $('.current.page')
	}
	// just find the prev one...
	var articles = $('.article')
	return setCurrentPage(
		$(articles[Math.max(articles.index(cur)-1, 0)])
			.children('.page')
			.first())
}



// Return a scale value for the given element(s).
// NOTE: this will only return a single scale value...
function getElementScale(elem){
	//var transform = elem.css('transform')
	var vendors = ['o', 'moz', 'ms', 'webkit']
	var transform = elem.css('transform')
	var res

	// go through vendor prefixes... (hate this!)
	if(!transform || transform == 'none'){
		for(var i in vendors){
			transform = elem.css('-' + vendors[i] + '-transform')
			if(transform && transform != 'none'){
				break
			}
		}
	}
	// no transform is set...
	if(!transform || transform == 'none'){
		return 1
	}
	// get the scale value -- first argument of scale/matrix...
	return parseFloat((/(scale|matrix)\(([^,]*),.*\)/).exec(transform)[2])
}

function setElementScale(elem, scale){
	return elem.css({
		'transform': 'scale('+scale+')',
		'-moz-transform': 'scale('+scale+')',
		'-o-transform': 'scale('+scale+')',
		'-ms-transform': 'scale('+scale+')',
		'-webkit-transform': 'scale('+scale+')',
	})
}



function fitNPages(n){
	if(n==null){
		n = 1
	}
	var pages = $('.page')
	var scale = $('.viewer').width()/(pages.width()*n)

	// fit vertically if needed...
	if(pages.height()*scale > $('.viewer').height()){
		scale = $('.viewer').height()/pages.height()
	}

	setElementScale($('.scaler'), scale)
}




// XXX create magazine...
function createMagazine(){
}

// XXX create article (magazine, title, position)...
function createArticle(magazine, title){
}

// XXX create page (article, template, position)...
function createPage(article, template){
}



</script>
</head>
<body>

<div class="viewer">
<div class="scaler">
<div class="aligner">
	<div class="magazine">
		<div class="cover page current">
			Magazine Cover
		</div>

		<!-- XXX do we need a Magazine Credits page??? -->

		<div class="article">
			<div class="cover page">
				Article Cover<br>
				some more text...
			</div>

			<!-- XXX do we need an Article Credits page??? -->

			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
		</div>
		<div class="article">
			<div class="cover page">
				Article Cover
			</div>

			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
		</div>
		<div class="article">
			<div class="cover page">
				Article Cover
			</div>

			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
		</div>
		<div class="article">
			<div class="cover page">
				Article Cover
			</div>

			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
			<div class="page">
				Page
			</div>
		</div>
	</div>
</div>
</div>
</div>


</body>
</html>
